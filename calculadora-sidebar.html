<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Prazos Úteis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Inter', sans-serif;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Container principal ajustado para sidebar */
        .main-container {
            width: 100%;
            max-width: 100%;
            padding: 12px;
            background: white;
            min-height: 100vh; /* Mantido para fallback, mas h-screen com flex é mais eficaz */
        }
        
        /* Ajustes responsivos para telas pequenas */
        @media (max-width: 400px) {
            .main-container {
                padding: 8px;
            }
        }
        
        /* Scrollbar customizada para melhor aparência */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-white">

    <!-- Container principal agora com flexbox para ocupar 100% da altura -->
    <div class="main-container flex flex-col h-screen">
        
        <!-- Cabeçalho (não encolhe) -->
        <div class="text-center mb-4 flex-shrink-0">
            <h1 class="text-xl font-bold text-gray-800">Calculadora de Prazos</h1>
            <p id="status-feriados" class="text-xs text-gray-500 mt-1">Carregando feriados...</p>
        </div>

        <!-- Formulário (não encolhe) -->
        <form id="prazo-form" class="space-y-4 flex-shrink-0">
            <div>
                <label for="data-inicio" class="block text-xs font-medium text-gray-700 mb-1">Data de Início</label>
                <input type="date" id="data-inicio" name="data-inicio" required
                       class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            </div>

            <div>
                <label for="dias-uteis" class="block text-xs font-medium text-gray-700 mb-1">Quantidade de Dias Úteis</label>
                <input type="number" id="dias-uteis" name="dias-uteis" min="1" required
                       class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                       placeholder="Ex: 15">
            </div>

            <button type="submit" id="calcular-btn"
                    class="w-full bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 transition duration-200 flex items-center justify-center">
                <span id="btn-text">Calcular Prazo</span>
                <div id="loader" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-4 w-4 ml-2 hidden"></div>
            </button>
        </form>

        <!-- Resultado (não encolhe) -->
        <div id="resultado-div" class="mt-4 p-3 bg-blue-50 rounded-md text-center hidden flex-shrink-0">
            <p class="text-xs text-gray-600">O prazo final é:</p>
            <p id="data-final" class="text-lg font-bold text-blue-600 mt-0.5"></p>
        </div>
        
        <!-- Detalhamento: agora flexível para ocupar o espaço restante -->
        <div id="detalhes-div" class="mt-4 hidden flex flex-col flex-grow min-h-0">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 text-center flex-shrink-0">Detalhamento da Contagem</h3>
            <!-- A lista agora usa o espaço do pai e tem sua própria rolagem se necessário -->
            <div id="detalhes-lista" class="overflow-y-auto p-2 bg-gray-50 rounded-md border text-xs space-y-1">
                <!-- Conteúdo será gerado dinamicamente -->
            </div>
        </div>

        <!-- Botão de Exportar (não encolhe) -->
        <div id="export-div" class="mt-4 text-center hidden flex-shrink-0">
            <button id="export-pdf-btn"
                    class="bg-green-600 text-white text-sm font-medium py-1.5 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500 transition duration-200">
                Exportar PDF
            </button>
        </div>

        <!-- Mensagem de erro (não encolhe) -->
        <div id="error-div" class="mt-4 p-3 bg-red-100 border border-red-300 text-red-800 text-xs rounded-md text-center hidden flex-shrink-0">
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const SHEET_ID = "14FujwpVbZDXsdeDyCd8vOErYiGls1cCphBryRmJ4ND4";
        const SHEET_GID = "0";
        const googleSheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Lista de feriados hardcoded como um fallback de último recurso.
        const feriadosFallback = {
            "2025-01-01": "Recesso Judiciário", "2025-01-02": "Recesso Judiciário", "2025-01-03": "Recesso Judiciário", 
            "2025-01-04": "Recesso Judiciário", "2025-01-05": "Recesso Judiciário", "2025-01-06": "Recesso Judiciário", 
            "2025-01-07": "Recesso Judiciário", "2025-01-08": "Suspensão do Prazo", "2025-01-09": "Suspensão do Prazo", 
            "2025-01-10": "Suspensão do Prazo", "2025-01-11": "Suspensão do Prazo", "2025-01-12": "Suspensão do Prazo", 
            "2025-01-13": "Suspensão do Prazo", "2025-01-14": "Suspensão do Prazo", "2025-01-15": "Suspensão do Prazo", 
            "2025-01-16": "Suspensão do Prazo", "2025-01-17": "Suspensão do Prazo", "2025-01-18": "Suspensão do Prazo", 
            "2025-01-19": "Suspensão do Prazo", "2025-01-20": "Suspensão do Prazo", "2025-03-03": "Carnaval", 
            "2025-03-04": "Carnaval", "2025-03-05": "Carnaval", "2025-04-17": "Quinta-Feira Santa", 
            "2025-04-18": "Paixão de Cristo", "2025-04-21": "Tiradentes", "2025-05-01": "Dia do Trabalhador", 
            "2025-05-02": "Ponto Facultativo", "2025-05-19": "Dia do Defensor", "2025-06-19": "Corpus Christi", 
            "2025-06-20": "Ponto Facultativo", "2025-06-27": "Festival de Parintins", "2025-07-04": "Instalação do Jud.", 
            "2025-08-04": "Semana de Atenção à Pessoa", "2025-08-05": "Semana de Atenção à Pessoa", 
            "2025-08-06": "Semana de Atenção à Pessoa", "2025-08-07": "Semana de Atenção à Pessoa", 
            "2025-08-08": "Semana de Atenção à Pessoa", "2025-08-11": "Dia do Advogado", "2025-09-05": "Elevação do Am", 
            "2025-09-07": "Independência", "2025-10-12": "N. S. Aparecida", "2025-10-24": "Elevação de MAO", 
            "2025-10-28": "Dia do Servidor", "2025-11-02": "Finados", "2025-11-15": "Proclamação da República", 
            "2025-11-20": "Consciência Negra", "2025-11-21": "Ponto Facultativo", "2025-12-08": "N. S. da Conceição", 
            "2025-12-14": "Dia do MP", "2025-12-20": "Recesso", "2025-12-21": "Recesso", "2025-12-22": "Recesso", 
            "2025-12-23": "Recesso", "2025-12-24": "Recesso", "2025-12-25": "Recesso", "2025-12-26": "Recesso", 
            "2025-12-27": "Recesso", "2025-12-28": "Recesso", "2025-12-29": "Recesso", "2025-12-30": "Recesso", 
            "2025-12-31": "Recesso"
        };
        
        let listaDeFeriados = {};
        let ultimoResultado = null;
        const diasDaSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];

        async function buscarFeriadosOnline(url) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erro na rede: Status ${response.status}`);
                
                const csvData = await response.text();
                const feriados = {};
                const rows = csvData.split('\n').slice(1);

                rows.forEach(row => {
                    const columns = row.split(',');
                    if (columns.length > 1 && columns[0] && columns[1]) {
                        const nomeFeriado = columns[0].trim();
                        const dateParts = columns[1].trim().split('/');
                        if (dateParts.length === 3) {
                            const [day, month, year] = dateParts;
                            // Ignora linhas mal formatadas que não tenham um ano válido
                            if (year && year.length === 4) {
                                const dataFormatada = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                feriados[dataFormatada] = nomeFeriado;
                            }
                        }
                    }
                });
                // Retorna o objeto apenas se ele contiver feriados válidos
                return Object.keys(feriados).length > 0 ? feriados : null;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') console.error("Falha ao buscar feriados online: timeout.");
                else console.error("Falha ao buscar feriados online:", error);
                return null;
            }
        }

        function calcularPrazoUtil(dataInicio, diasUteis, feriados) {
            let dataAtual = new Date(dataInicio.valueOf());
            let diasUteisContados = 0;
            const detalhes = [];

            while (diasUteisContados < diasUteis) {
                dataAtual.setDate(dataAtual.getDate() + 1);
                
                const diaDaSemana = dataAtual.getDay();
                const dataFormatada = dataAtual.toISOString().split('T')[0];
                const isFimDeSemana = diaDaSemana === 0 || diaDaSemana === 6;
                const nomeFeriado = feriados[dataFormatada];

                let status = '';
                let diaUtilNumero = null;

                if (!isFimDeSemana && !nomeFeriado) {
                    diasUteisContados++;
                    status = 'Dia útil';
                    diaUtilNumero = diasUteisContados;
                } else if (nomeFeriado) {
                    status = 'Feriado';
                } else {
                    status = 'Fim de semana';
                }
                
                detalhes.push({
                    data: new Date(dataAtual.valueOf()),
                    status: status,
                    diaUtilNumero: diaUtilNumero,
                    nomeFeriado: nomeFeriado || null
                });
            }
            return { dataFinal: dataAtual, detalhes };
        }

        function exportarParaPDF() {
            if (!ultimoResultado) {
                alert("Nenhum resultado para exportar. Por favor, calcule um prazo primeiro.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const dataInicio = new Date(`${document.getElementById('data-inicio').value}T00:00:00`);
            const diasUteis = document.getElementById('dias-uteis').value;

            doc.setFontSize(18);
            doc.text("Relatório de Contagem de Prazo", 105, 20, { align: "center" });
            doc.setFontSize(12);
            doc.text(`Data de Início: ${dataInicio.toLocaleDateString('pt-BR')}`, 14, 35);
            doc.text(`Dias Úteis Contados: ${diasUteis}`, 14, 42);
            doc.text(`Data Final Encontrada: ${ultimoResultado.dataFinal.toLocaleDateString('pt-BR')}`, 14, 49);
            
            const drawTableHeader = (yPos) => {
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Data", 14, yPos);
                doc.text("Dia da Semana", 50, yPos);
                doc.text("Status", 130, yPos);
                let newY = yPos + 3;
                doc.setLineWidth(0.2);
                doc.line(14, newY, 196, newY);
                return newY + 5;
            };

            doc.setFontSize(14);
            doc.text("Detalhamento da Contagem", 14, 65);
            doc.setLineWidth(0.5);
            doc.line(14, 67, 196, 67);

            let y = 75;
            y = drawTableHeader(y);
            doc.setTextColor(0);

            ultimoResultado.detalhes.forEach(dia => {
                const diaFormatado = dia.data.toLocaleDateString('pt-BR');
                const nomeDiaSemana = diasDaSemana[dia.data.getDay()];
                let statusText = '';

                if (dia.status === 'Dia útil') {
                    statusText = `Dia útil #${dia.diaUtilNumero}`;
                } else if (dia.status === 'Feriado') {
                    statusText = dia.nomeFeriado;
                } else {
                    statusText = 'Fim de semana';
                }

                const lines = doc.splitTextToSize(statusText, 65);
                const blockHeight = lines.length * 5;

                if (y + blockHeight > 280) {
                    doc.addPage();
                    y = 20;
                    y = drawTableHeader(y);
                    doc.setTextColor(0);
                }
                
                doc.text(diaFormatado, 14, y);
                doc.text(nomeDiaSemana, 50, y);
                doc.text(lines, 130, y);

                y += blockHeight + 2;
            });

            doc.save(`contagem_prazo_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // --- LÓGICA DE CARREGAMENTO DOS FERIADOS (COM CACHE) ---
        document.addEventListener('DOMContentLoaded', () => {
            const statusFeriadosEl = document.getElementById('status-feriados');

            // 1. Tenta carregar do cache local primeiro
            try {
                const feriadosEmCache = localStorage.getItem('feriadosCache');
                if (feriadosEmCache) {
                    listaDeFeriados = JSON.parse(feriadosEmCache);
                    statusFeriadosEl.textContent = 'Feriados (cache) ✓';
                    statusFeriadosEl.classList.replace('text-gray-500', 'text-blue-600');
                } else {
                    // 2. Se não houver cache, usa o fallback
                    listaDeFeriados = feriadosFallback;
                    statusFeriadosEl.textContent = 'Usando feriados offline';
                    statusFeriadosEl.classList.replace('text-gray-500', 'text-amber-600');
                }
            } catch (e) {
                // Se o cache estiver corrompido, usa o fallback
                console.error("Erro ao ler cache de feriados:", e);
                listaDeFeriados = feriadosFallback;
            }

            // 3. Tenta buscar a versão mais recente online
            buscarFeriadosOnline(googleSheetUrl).then(feriadosOnline => {
                if (feriadosOnline) {
                    console.log("Feriados atualizados da fonte online.");
                    listaDeFeriados = feriadosOnline; // Atualiza a lista em uso
                    
                    // 4. Se a busca online funcionar, ATUALIZA O CACHE LOCAL
                    try {
                        localStorage.setItem('feriadosCache', JSON.stringify(feriadosOnline));
                        statusFeriadosEl.textContent = `Feriados carregados online ✓`;
                        statusFeriadosEl.classList.replace('text-gray-500', 'text-green-600');
                        statusFeriadosEl.classList.remove('text-blue-600', 'text-amber-600');
                    } catch (e) {
                        console.error("Não foi possível salvar os feriados no cache:", e);
                    }
                } else {
                    console.log("Não foi possível buscar feriados online. Usando versão em cache ou offline.");
                }
            });
        });

        document.getElementById('prazo-form').addEventListener('submit', (event) => {
            event.preventDefault();
            
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('loader');
            const resultadoDiv = document.getElementById('resultado-div');
            const errorDiv = document.getElementById('error-div');
            const detalhesDiv = document.getElementById('detalhes-div');
            const detalhesLista = document.getElementById('detalhes-lista');
            const exportDiv = document.getElementById('export-div');

            resultadoDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            detalhesDiv.classList.add('hidden');
            exportDiv.classList.add('hidden');
            detalhesLista.innerHTML = '';
            btnText.textContent = 'Calculando...';
            loader.classList.remove('hidden');

            try {
                const dataInicioStr = document.getElementById('data-inicio').value;
                const diasUteis = parseInt(document.getElementById('dias-uteis').value);

                if (!dataInicioStr || isNaN(diasUteis) || diasUteis <= 0) {
                    throw new Error("Por favor, preencha todos os campos corretamente.");
                }
                
                const dataInicio = new Date(`${dataInicioStr}T00:00:00`);
                // Garante que haja uma lista de feriados para calcular
                if (Object.keys(listaDeFeriados).length === 0) {
                    throw new Error("A lista de feriados não está disponível. Tente recarregar.")
                }
                const resultado = calcularPrazoUtil(dataInicio, diasUteis, listaDeFeriados);
                ultimoResultado = resultado;

                document.getElementById('data-final').textContent = resultado.dataFinal.toLocaleDateString('pt-BR');
                resultadoDiv.classList.remove('hidden');

                resultado.detalhes.forEach(dia => {
                    let statusClass = '';
                    let statusText = dia.status;

                    if (dia.status === 'Dia útil') {
                        statusClass = 'text-green-700 font-medium';
                        statusText = `Útil #${dia.diaUtilNumero}`;
                    } else if (dia.status === 'Feriado') {
                        statusClass = 'text-red-600';
                        statusText = dia.nomeFeriado;
                    } else {
                        statusClass = 'text-gray-500';
                        statusText = 'Fim de semana';
                    }

                    const diaFormatado = dia.data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    const nomeDiaSemana = diasDaSemana[dia.data.getDay()];
                    
                    const itemHtml = `
                        <div class="flex justify-between items-center text-xs p-1.5 hover:bg-white rounded">
                            <span class="text-gray-700">${diaFormatado} (${nomeDiaSemana})</span>
                            <span class="${statusClass} text-right" style="font-size: 11px;">${statusText}</span>
                        </div>
                    `;
                    detalhesLista.innerHTML += itemHtml;
                });
                detalhesDiv.classList.remove('hidden');
                exportDiv.classList.remove('hidden');

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btnText.textContent = 'Calcular Prazo';
                loader.classList.add('hidden');
            }
        });

        document.getElementById('export-pdf-btn').addEventListener('click', exportarParaPDF);
    </script>

</body>
</html>
