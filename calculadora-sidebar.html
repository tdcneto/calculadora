<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Prazos Úteis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Calculadora de Prazos</h1>
            <p id="status-feriados" class="text-sm text-gray-500 mt-2">Carregando feriados...</p>
        </div>

        <form id="prazo-form" class="space-y-6">
            <div>
                <label for="data-inicio" class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label>
                <input type="date" id="data-inicio" name="data-inicio" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            </div>

            <div>
                <label for="dias-uteis" class="block text-sm font-medium text-gray-700 mb-1">Quantidade de Dias Úteis</label>
                <input type="number" id="dias-uteis" name="dias-uteis" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ex: 15">
            </div>

            <button type="submit" id="calcular-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center">
                <span id="btn-text">Calcular Prazo</span>
                <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
            </button>
        </form>

        <div id="resultado-div" class="mt-8 p-5 bg-gray-50 rounded-lg text-center hidden">
            <p class="text-gray-600">O prazo final é:</p>
            <p id="data-final" class="text-2xl font-bold text-blue-600 mt-1"></p>
        </div>
        
        <div id="detalhes-div" class="mt-6 hidden">
            <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">Detalhamento da Contagem</h3>
            <div id="detalhes-lista" class="max-h-60 overflow-y-auto p-3 bg-gray-50 rounded-lg border space-y-2">
                <!-- Conteúdo será gerado dinamicamente -->
            </div>
        </div>

        <!-- Botão de Exportar para PDF -->
        <div id="export-div" class="mt-6 text-center hidden">
            <button id="export-pdf-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out">
                Exportar para PDF
            </button>
        </div>

        <div id="error-div" class="mt-6 p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg text-center hidden">
        </div>

    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const SHEET_ID = "14FujwpVbZDXsdeDyCd8vOErYiGls1cCphBryRmJ4ND4";
        const SHEET_GID = "0";
        const googleSheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        const feriadosFallback = {
            "2025-01-01": "Recesso Judiciário", "2025-01-02": "Recesso Judiciário", "2025-01-03": "Recesso Judiciário", "2025-01-04": "Recesso Judiciário", "2025-01-05": "Recesso Judiciário", "2025-01-06": "Recesso Judiciário", "2025-01-07": "Recesso Judiciário", "2025-01-08": "Suspensão do Prazo", "2025-01-09": "Suspensão do Prazo", "2025-01-10": "Suspensão do Prazo", "2025-01-11": "Suspensão do Prazo", "2025-01-12": "Suspensão do Prazo", "2025-01-13": "Suspensão do Prazo", "2025-01-14": "Suspensão do Prazo", "2025-01-15": "Suspensão do Prazo", "2025-01-16": "Suspensão do Prazo", "2025-01-17": "Suspensão do Prazo", "2025-01-18": "Suspensão do Prazo", "2025-01-19": "Suspensão do Prazo", "2025-01-20": "Suspensão do Prazo", "2025-03-03": "Carnaval", "2025-03-04": "Carnaval", "2025-03-05": "Carnaval", "2025-04-17": "Quinta-Feira Santa", "2025-04-18": "Paixão de Cristo", "2025-04-21": "Tiradentes", "2025-05-01": "Dia do Trabalhador", "2025-05-02": "Ponto Facultativo", "2025-05-19": "Dia do Defensor", "2025-06-19": "Corpus Christi", "2025-06-20": "Ponto Facultativo", "2025-06-27": "Festival de Parintins", "2025-07-04": "Instalação do Jud.", "2025-08-04": "Semana de Atenção à Pessoa", "2025-08-05": "Semana de Atenção à Pessoa", "2025-08-06": "Semana de Atenção à Pessoa", "2025-08-07": "Semana de Atenção à Pessoa", "2025-08-08": "Semana de Atenção à Pessoa", "2025-08-11": "Dia do Advogado", "2025-09-05": "Elevação do Am", "2025-09-07": "Independência", "2025-10-12": "N. S. Aparecida", "2025-10-24": "Elevação de MAO", "2025-10-28": "Dia do Servidor", "2025-11-02": "Finados", "2025-11-15": "Proclamação da República", "2025-11-20": "Consciência Negra", "2025-11-21": "Ponto Facultativo", "2025-12-08": "N. S. da Conceição", "2025-12-14": "Dia do MP", "2025-12-20": "Recesso", "2025-12-21": "Recesso", "2025-12-22": "Recesso", "2025-12-23": "Recesso", "2025-12-24": "Recesso", "2025-12-25": "Recesso", "2025-12-26": "Recesso", "2025-12-27": "Recesso", "2025-12-28": "Recesso", "2025-12-29": "Recesso", "2025-12-30": "Recesso", "2025-12-31": "Recesso"
        };
        
        let listaDeFeriados = {};
        let ultimoResultado = null; // Armazena o último resultado para exportação
        const diasDaSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];

        // --- FUNÇÕES DE LÓGICA ---

        async function buscarFeriadosOnline(url) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erro na rede: Status ${response.status}`);
                
                const csvData = await response.text();
                const feriados = {};
                const rows = csvData.split('\n').slice(1);

                rows.forEach(row => {
                    const columns = row.split(',');
                    if (columns.length > 1 && columns[0] && columns[1]) {
                        const nomeFeriado = columns[0].trim();
                        const dateParts = columns[1].trim().split('/');
                        if (dateParts.length === 3) {
                            const [day, month, year] = dateParts;
                            const dataFormatada = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            feriados[dataFormatada] = nomeFeriado;
                        }
                    }
                });
                return feriados;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') console.error("Falha ao buscar feriados online: A requisição demorou muito (timeout).");
                else console.error("Falha ao buscar feriados online:", error);
                return null;
            }
        }

        function calcularPrazoUtil(dataInicio, diasUteis, feriados) {
            let dataAtual = new Date(dataInicio.valueOf());
            let diasUteisContados = 0;
            const detalhes = [];

            while (diasUteisContados < diasUteis) {
                dataAtual.setDate(dataAtual.getDate() + 1);
                
                const diaDaSemana = dataAtual.getDay();
                const dataFormatada = dataAtual.toISOString().split('T')[0];
                const isFimDeSemana = diaDaSemana === 0 || diaDaSemana === 6;
                const nomeFeriado = feriados[dataFormatada];

                let status = '';
                let diaUtilNumero = null;

                if (!isFimDeSemana && !nomeFeriado) {
                    diasUteisContados++;
                    status = 'Dia útil';
                    diaUtilNumero = diasUteisContados;
                } else if (nomeFeriado) {
                    status = 'Feriado';
                } else {
                    status = 'Fim de semana';
                }
                
                detalhes.push({
                    data: new Date(dataAtual.valueOf()),
                    status: status,
                    diaUtilNumero: diaUtilNumero,
                    nomeFeriado: nomeFeriado || null
                });
            }
            return { dataFinal: dataAtual, detalhes };
        }

        function exportarParaPDF() {
            if (!ultimoResultado) {
                alert("Nenhum resultado para exportar. Por favor, calcule um prazo primeiro.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const dataInicio = new Date(`${document.getElementById('data-inicio').value}T00:00:00`);
            const diasUteis = document.getElementById('dias-uteis').value;

            // Título e Resumo
            doc.setFontSize(18);
            doc.text("Relatório de Contagem de Prazo", 105, 20, { align: "center" });
            doc.setFontSize(12);
            doc.text(`Data de Início: ${dataInicio.toLocaleDateString('pt-BR')}`, 14, 35);
            doc.text(`Dias Úteis Contados: ${diasUteis}`, 14, 42);
            doc.text(`Data Final Encontrada: ${ultimoResultado.dataFinal.toLocaleDateString('pt-BR')}`, 14, 49);
            
            // Função para desenhar o cabeçalho da tabela
            const drawTableHeader = (yPos) => {
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Data", 14, yPos);
                doc.text("Dia da Semana", 50, yPos);
                doc.text("Status", 130, yPos);
                let newY = yPos + 3;
                doc.setLineWidth(0.2);
                doc.line(14, newY, 196, newY);
                return newY + 5;
            };

            // Tabela de Detalhes
            doc.setFontSize(14);
            doc.text("Detalhamento da Contagem", 14, 65);
            doc.setLineWidth(0.5);
            doc.line(14, 67, 196, 67);

            let y = 75;
            y = drawTableHeader(y);
            doc.setTextColor(0);

            ultimoResultado.detalhes.forEach(dia => {
                const diaFormatado = dia.data.toLocaleDateString('pt-BR');
                const nomeDiaSemana = diasDaSemana[dia.data.getDay()];
                let statusText = '';

                if (dia.status === 'Dia útil') {
                    statusText = `Dia útil #${dia.diaUtilNumero}`;
                } else if (dia.status === 'Feriado') {
                    statusText = dia.nomeFeriado;
                } else {
                    statusText = 'Fim de semana';
                }

                const lines = doc.splitTextToSize(statusText, 65); // Divide o texto para caber na coluna
                const blockHeight = lines.length * 5; // Altura do bloco de texto (5 é uma boa altura de linha)

                if (y + blockHeight > 280) { // Adiciona nova página se o conteúdo passar do limite
                    doc.addPage();
                    y = 20;
                    y = drawTableHeader(y);
                    doc.setTextColor(0);
                }
                
                doc.text(diaFormatado, 14, y);
                doc.text(nomeDiaSemana, 50, y);
                doc.text(lines, 130, y); // jsPDF desenha o array de linhas automaticamente

                y += blockHeight + 2; // Move y para baixo pela altura do bloco + um espaçamento
            });

            doc.save(`contagem_prazo_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // --- INICIALIZAÇÃO E EVENTOS ---

        document.addEventListener('DOMContentLoaded', async () => {
            const statusFeriadosEl = document.getElementById('status-feriados');
            listaDeFeriados = await buscarFeriadosOnline(googleSheetUrl);
            
            if (listaDeFeriados && Object.keys(listaDeFeriados).length > 0) {
                statusFeriadosEl.textContent = `Feriados carregados da planilha online.`;
                statusFeriadosEl.classList.replace('text-gray-500', 'text-green-600');
            } else {
                listaDeFeriados = feriadosFallback;
                statusFeriadosEl.textContent = 'Aviso: Usando lista de feriados interna (offline).';
                statusFeriadosEl.classList.replace('text-gray-500', 'text-amber-600');
            }
        });

        document.getElementById('prazo-form').addEventListener('submit', (event) => {
            event.preventDefault();
            
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('loader');
            const resultadoDiv = document.getElementById('resultado-div');
            const errorDiv = document.getElementById('error-div');
            const detalhesDiv = document.getElementById('detalhes-div');
            const detalhesLista = document.getElementById('detalhes-lista');
            const exportDiv = document.getElementById('export-div');

            // Reset UI
            resultadoDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            detalhesDiv.classList.add('hidden');
            exportDiv.classList.add('hidden');
            detalhesLista.innerHTML = '';
            btnText.textContent = 'Calculando...';
            loader.classList.remove('hidden');

            try {
                const dataInicioStr = document.getElementById('data-inicio').value;
                const diasUteis = parseInt(document.getElementById('dias-uteis').value);

                if (!dataInicioStr || isNaN(diasUteis) || diasUteis <= 0) {
                    throw new Error("Por favor, preencha todos os campos corretamente.");
                }
                
                const dataInicio = new Date(`${dataInicioStr}T00:00:00`);
                const resultado = calcularPrazoUtil(dataInicio, diasUteis, listaDeFeriados);
                ultimoResultado = resultado; // Salva para exportação

                // Mostra o resultado final
                document.getElementById('data-final').textContent = resultado.dataFinal.toLocaleDateString('pt-BR');
                resultadoDiv.classList.remove('hidden');

                // Popula e mostra o detalhamento
                resultado.detalhes.forEach(dia => {
                    let statusClass = '';
                    let statusText = dia.status;

                    if (dia.status === 'Dia útil') {
                        statusClass = 'text-green-700';
                        statusText = `Dia útil #${dia.diaUtilNumero}`;
                    } else if (dia.status === 'Feriado') {
                        statusClass = 'text-red-600';
                        statusText = dia.nomeFeriado;
                    } else {
                        statusClass = 'text-gray-500';
                    }

                    const diaFormatado = dia.data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const nomeDiaSemana = diasDaSemana[dia.data.getDay()];
                    
                    const itemHtml = `
                        <div class="flex justify-between items-center text-sm p-2 rounded">
                            <span>${diaFormatado} <span class="text-gray-400">- ${nomeDiaSemana}</span></span>
                            <span class="font-semibold ${statusClass}">${statusText}</span>
                        </div>
                    `;
                    detalhesLista.innerHTML += itemHtml;
                });
                detalhesDiv.classList.remove('hidden');
                exportDiv.classList.remove('hidden'); // Mostra o botão de exportar

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btnText.textContent = 'Calcular Prazo';
                loader.classList.add('hidden');
            }
        });

        document.getElementById('export-pdf-btn').addEventListener('click', exportarParaPDF);
    </script>

</body>
</html>
